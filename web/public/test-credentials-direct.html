<!DOCTYPE html>
<html>
<head>
    <title>Direct Credentials Test</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>NextAuth Credentials Test</h1>
    <div id="result"></div>
    
    <script>
        async function testCredentials() {
            const resultDiv = document.getElementById('result');
            
            try {
                resultDiv.innerHTML = 'Testing NextAuth credentials...<br>';
                
                // Step 1: Get CSRF token
                const csrfResponse = await axios.get('/api/auth/csrf');
                const csrfToken = csrfResponse.data.csrfToken;
                resultDiv.innerHTML += `CSRF Token: ${csrfToken.substring(0, 20)}...<br>`;
                
                // Step 2: Create form data exactly like NextAuth expects
                const formData = new FormData();
                formData.append('email', 'test@example.com');
                formData.append('password', 'testpassword123');
                formData.append('csrfToken', csrfToken);
                formData.append('callbackUrl', '/dashboard');
                formData.append('json', 'true');
                
                // Step 3: Submit to the credentials callback endpoint
                const response = await axios.post('/api/auth/callback/credentials', formData, {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    maxRedirects: 0,
                    validateStatus: function (status) {
                        return status >= 200 && status < 400;
                    }
                });
                
                resultDiv.innerHTML += `Response Status: ${response.status}<br>`;
                resultDiv.innerHTML += `Response Data: ${JSON.stringify(response.data)}<br>`;
                
                if (response.headers.location) {
                    resultDiv.innerHTML += `Redirect Location: ${response.headers.location}<br>`;
                }
                
                // Step 4: Check session
                const sessionResponse = await axios.get('/api/auth/session');
                resultDiv.innerHTML += `Session: ${JSON.stringify(sessionResponse.data)}<br>`;
                
                if (sessionResponse.data.user) {
                    resultDiv.innerHTML += `<span style="color: green;">✅ SUCCESS! Logged in as: ${sessionResponse.data.user.email}</span>`;
                } else {
                    resultDiv.innerHTML += `<span style="color: red;">❌ FAILED: No session found</span>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<span style="color: red;">ERROR: ${error.message}</span><br>`;
                if (error.response) {
                    resultDiv.innerHTML += `Response Status: ${error.response.status}<br>`;
                    resultDiv.innerHTML += `Response Data: ${JSON.stringify(error.response.data)}<br>`;
                }
            }
        }
        
        // Run test when page loads
        window.onload = testCredentials;
    </script>
</body>
</html>